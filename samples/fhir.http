 #################################################
# FHIR Server Test Requests
# Lab Result Follow-up Recommendation Agent Demo
#################################################
# This file contains HTTP requests for testing the InterSystems IRIS FHIR R4 server
# Use with VS Code REST Client extension
#
# Usage:
# - Click "Send Request" above any ### section to execute that request
# - Variables defined with @ are reusable throughout the file
# - Dynamic variables like {{$datetime iso8601}} generate fresh values on each request
#################################################

# ===== Configuration Variables =====
# FHIR server base URL
@fhirUrl = http://localhost:52774/interop/fhir/r4

# Authentication credentials
@username = superuser
@password = SYS

# Test data identifiers
@patientId = 1
@observationCode = 2160-0

# Auto-generated ISO 8601 timestamp (refreshes on each request)
@timestamp = {{$datetime iso8601}}

#################################################
# Server Metadata & Capability Statement
#################################################

### Get FHIR server capability statement
# Returns server metadata, supported resources, and operations
GET {{fhirUrl}}/metadata
Accept: application/fhir+json

#################################################
# Patient Resources
#################################################

### List all patients
# Retrieves all Patient resources from the FHIR server
GET {{fhirUrl}}/Patient
Accept: application/fhir+json
Authorization: Basic {{username}}:{{password}}

### Get complete patient context
# Uses the $everything operation to retrieve all resources related to a specific patient
# Includes: Observations, Conditions, MedicationRequests, etc.
GET {{fhirUrl}}/Patient/{{patientId}}/$everything
Accept: application/fhir+json
Authorization: Basic {{username}}:{{password}}

#################################################
# Observation Resources (Laboratory Results)
#################################################

### List all observations
# Retrieves all Observation resources (lab results, vital signs, etc.)
GET {{fhirUrl}}/Observation
Accept: application/fhir+json
Authorization: Basic {{username}}:{{password}}

### Get creatinine lab trend for patient
# Query parameters:
# - subject: Filter by patient reference
# - code: Filter by LOINC code (2160-0 = Serum Creatinine)
# - _sort=-date: Sort by date descending (most recent first)
GET {{fhirUrl}}/Observation?subject=Patient/{{patientId}}&code={{observationCode}}&_sort=-date
Accept: application/fhir+json
Authorization: Basic {{username}}:{{password}}

#################################################
# Create Resources (Write Operations)
#################################################

### Create new creatinine observation
# Posts a new abnormal creatinine result to trigger the AI workflow
# This simulates an incoming lab result from a laboratory system
#
# Key fields:
# - effectiveDateTime: Uses auto-generated timestamp ({{timestamp}})
# - value: 2.1 mg/dL (elevated, triggering "H" = High interpretation)
# - subject: References Patient/{{patientId}}
# - code: LOINC 2160-0 (Serum Creatinine)
#
# After creating this observation, the AI agent will be triggered to 
# analyze some follow-up recommendations.
POST {{fhirUrl}}/Observation
Content-Type: application/fhir+json
Accept: application/fhir+json
Authorization: Basic {{username}}:{{password}}

{
  "resourceType": "Observation",
  "status": "final",
  "category": [
    {
      "coding": [
        {
          "system": "http://terminology.hl7.org/CodeSystem/observation-category",
          "code": "laboratory",
          "display": "Laboratory"
        }
      ]
    }
  ],
  "code": {
    "coding": [
      {
        "system": "http://loinc.org",
        "code": "2160-0",
        "display": "Creatinine [Mass/volume] in Serum or Plasma"
      }
    ],
    "text": "Serum creatinine"
  },
  "subject": {
    "reference": "Patient/{{patientId}}"
  },
  "effectiveDateTime": "{{timestamp}}",
  "valueQuantity": {
    "value": 2.1,
    "unit": "mg/dL",
    "system": "http://unitsofmeasure.org",
    "code": "mg/dL"
  },
  "interpretation": [
    {
      "coding": [
        {
          "system": "http://terminology.hl7.org/CodeSystem/v3-ObservationInterpretation",
          "code": "H"
        }
      ]
    }
  ]
}



### Retrieve generated DiagnosticReport for abnormal lab
# Retrieves all Patient resources from the FHIR server
GET {{fhirUrl}}/DiagnosticReport?result=Observation/14
Accept: application/fhir+json
Authorization: Basic {{username}}:{{password}}